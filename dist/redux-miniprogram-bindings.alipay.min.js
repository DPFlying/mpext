const t=my,e={page:["onLoad","onUnload"],component:["didMount","didUnmount"]},n=t=>"function"==typeof t,o=Array.isArray,s=Object.prototype.toString,c=t=>"[object Object]"===s.call(t),a=t=>s.call(t),i=Object.keys,r=t=>i(t).length<1,l=Object.prototype.hasOwnProperty,f=t=>{throw new Error(t)};function u(e){c(e)||f("provider必须是一个Object");const{store:n,namespace:o="",manual:s=!1}=e;n||f("store必须为Redux的Store实例对象"),t.$$provider={store:n,namespace:o,manual:s}}function p(){return t.$$provider||f("请先设置provider"),t.$$provider}const h=()=>p().store,g=()=>p().store.getState(),b=()=>{const{store:t}=p();return t.dispatch.bind(t)};function d(t){const e=g(),n={};for(let o=0,s=t.length;o<s;o++){const s=t[o];switch(typeof s){case"string":l.call(e,s)&&(n[s]=e[s]);break;case"function":{const t=s(e);c(t)&&!r(t)&&Object.assign(n,t);break}}}return n}function j(t,e){c(t)?function(t,e){const{dispatch:o}=p().store;for(const s in t){const c=t[s];n(c)&&(e[s]=(...t)=>o(c.apply(null,t)))}}(t,e):n(t)&&function(t,e){const n=t(p().store.dispatch);if(!c(n))throw new Error("mapDispatch 函数必须返回一个对象");Object.assign(e,n)}(t,e)}function m(t,e,n,o){const s=i(t),c=i(e),r=s.length,l=c.length;if(!(r<1&&l<1))if(r<1||l<1||r<l)n[o]=t;else{for(let e=0;e<l;e++){const a=c[e];if(s.indexOf(a)<0)return void(n[o]=t)}for(let i=0;i<r;i++){const r=s[i],l=t[r],f=`${o}.${r}`;if(c.indexOf(r)<0){n[f]=l;continue}const u=e[r];if(l!==u){const t=a(l);t!==a(u)?n[f]=l:"[object Object]"===t?m(l,u,n,f):"[object Array]"===t?y(l,u,n,f):n[f]=l}}}}function y(t,e,n,o){const s=t.length,c=e.length;if(!(s<1&&c<1))if(s<1||c<1||s<c)n[o]=t;else for(let i=0;i<s;i++){const s=t[i],r=`${o}[${i}]`;if(i>=c){n[r]=s;continue}const l=e[i];if(s!==l){const t=a(s);t!==a(l)?n[r]=s:"[object Object]"===t?m(s,l,n,r):"[object Array]"===t?y(s,l,n,r):n[r]=s}}}function O(t,e,n=""){const o=i(t),s=i(e),c=o.length,r=s.length;if(c<1&&r<1)return{};if(c<1||r<1)return n?{[n]:t}:t;const l={};for(let i=0;i<c;i++){const c=o[i],r=t[c],f=n?`${n}.${c}`:c;if(s.indexOf(c)<0){l[f]=r;continue}const u=e[c];if(r!==u){const t=a(r);t!==a(u)?l[f]=r:"[object Object]"===t?m(r,u,l,f):"[object Array]"===t?y(r,u,l,f):l[f]=r}}return l}var $=new class{constructor(){this.queue=[]}push(t,e,o){const s=this.queue;let c=null;for(let e=0,n=s.length;e<n;e++)if(s[e].thisArg===t){c=s[e];break}c||(c={thisArg:t,data:{},callbacks:[]},s.push(c)),Object.assign(c.data,e),n(o)&&c.callbacks.push(o),Promise.resolve().then(this.exec.bind(this))}exec(){if(this.queue.length<1)return;const t=this.queue;this.queue=[];const{namespace:e}=p();for(let n=0,o=t.length;n<o;n++){const o=t[n],{thisArg:s,data:c}=o,a=O(c,e?s.data[e]:s.data,e);r(a)||(o.diffData=a)}let n;for(;n=t.shift();){const{thisArg:t,diffData:e,callbacks:o}=n;let s;o.length>0&&(s=()=>{let t;for(;t=o.shift();)t()}),e?t.setData(e,s):s&&s()}}};let k=0,A=0;function v({type:t="page",mapState:n,mapDispatch:s,manual:a}={}){"page"!==t&&"component"!==t&&f("type属性只能是page或component");const i="page"===t,{namespace:l,manual:u}=p();return"boolean"!=typeof a&&(a=u),function(f){if(f.$$type=t,o(n)&&n.length>0){const o=d(n),[s,a]=e[t],i=f[s],u=f[a];let p=null;f.data=Object.assign(f.data||{},l?{[l]:o}:o),f[s]=function(...t){const e=d(n);if(!r(e)){const t=O(e,l?this.data[l]:this.data,l);r(t)||this.setData(t)}p=function(t,e){k+=1;const n=h();let o=n.getState();const s=n.subscribe(()=>{A+=1;const s=n.getState();let a=null;for(let t=0,n=e.length;t<n;t++){const n=e[t];switch(typeof n){case"string":s[n]!==o[n]&&(a||(a={}),a[n]=s[n]);break;case"function":{const t=n(s);c(t)&&!r(t)&&(a||(a={}),Object.assign(a,t));break}}}a&&$.push(t,a),o=s,A===k&&(A=0,$.exec())});return()=>{k-=1,s()}}(this,n),i&&i.apply(this,t)},f[a]=function(...t){u&&u.call(this,t),p&&(p(),p=null)}}if(s){const t=i?f:f.methods=f.methods||{};j(s,t)}return a?f:i?Page(f):Component(f)}}const w=(t={})=>v(Object.assign(Object.assign({},t),{type:"page"})),x=(t={})=>v(Object.assign(Object.assign({},t),{type:"component"}));export{x as $component,w as $page,v as connect,u as setProvider,b as useDispatch,g as useState,h as useStore};
