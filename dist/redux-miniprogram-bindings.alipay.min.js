const t=my,e={page:["onLoad","onUnload"],component:["didMount","didUnmount"]},n=t=>"function"==typeof t,o=Array.isArray,c=Object.prototype.toString,s=t=>"[object Object]"===c.call(t),a=t=>c.call(t),i=Object.keys,r=t=>i(t).length<1,f=Object.prototype.hasOwnProperty,u=t=>{throw new Error(t)};function l(e){s(e)||u("provider必须是一个Object");const{store:o,namespace:c="",manual:a=!1}=e;o&&n(o.getState)&&n(o.dispatch)&&n(o.subscribe)||u("store必须为Redux的Store实例对象"),t.$$provider={store:o,namespace:c,manual:a}}function p(){return t.$$provider||u("请先设置provider"),t.$$provider}const d=()=>p().store,g=()=>p().store.getState(),b=()=>p().store.dispatch;function h(t){const{store:e}=p();let n=e.getState();return e.subscribe(()=>{const o=e.getState();t(o,n),n=o})}function j(t){const{store:e}=p(),n={};return Object.defineProperty(n,"value",{configurable:!1,enumerable:!0,get:()=>t(e.getState())}),n}function y(t){const e=g(),n={};for(let o=0,c=t.length;o<c;o++){const c=t[o];switch(typeof c){case"string":f.call(e,c)&&(n[c]=e[c]);break;case"function":{const t=c(e);s(t)&&Object.assign(n,t);break}}}return n}function m(t,e){s(t)?function(t,e){const o=b(),c=i(t);for(let s=0,a=c.length;s<a;s++){const a=c[s],i=t[a];n(i)&&(e[a]=(...t)=>o(i.apply(null,t)))}}(t,e):n(t)&&function(t,e){const n=t(b());s(n)||u("mapDispatch函数必须返回一个对象"),Object.assign(e,n)}(t,e)}function O(t,e,n,o){const c=i(t),s=i(e),r=c.length,f=s.length;if(!(r<1&&f<1))if(r<1||f<1||r<f)n[o]=t;else{for(let e=0;e<f;e++){const a=s[e];if(c.indexOf(a)<0)return void(n[o]=t)}for(let i=0;i<r;i++){const r=c[i],f=t[r],u=`${o}.${r}`;if(s.indexOf(r)<0){n[u]=f;continue}const l=e[r];if(f!==l){const t=a(f);t!==a(l)?n[u]=f:"[object Object]"===t?O(f,l,n,u):"[object Array]"===t?$(f,l,n,u):n[u]=f}}}}function $(t,e,n,o){const c=t.length,s=e.length;if(!(c<1&&s<1))if(c<1||s<1||c<s)n[o]=t;else for(let i=0;i<c;i++){const c=t[i],r=`${o}[${i}]`;if(i>=s){n[r]=c;continue}const f=e[i];if(c!==f){const t=a(c);t!==a(f)?n[r]=c:"[object Object]"===t?O(c,f,n,r):"[object Array]"===t?$(c,f,n,r):n[r]=c}}}function v(t,e,n=""){const o=i(t),c=i(e),s=o.length,r=c.length;if(s<1&&r<1)return{};if(s<1||r<1)return n?{[n]:t}:t;const f={};for(let i=0;i<s;i++){const s=o[i],r=t[s],u=n?`${n}.${s}`:s;if(c.indexOf(s)<0){f[u]=r;continue}const l=e[s];if(r!==l){const t=a(r);t!==a(l)?f[u]=r:"[object Object]"===t?O(r,l,f,u):"[object Array]"===t?$(r,l,f,u):f[u]=r}}return f}const D={value:[]};let S=0,x=0;function w(t,e){S+=1;const n=h((n,o)=>{const c={};for(let t=0,a=e.length;t<a;t++){const a=e[t];switch(typeof a){case"string":n[a]!==o[a]&&(c[a]=n[a]);break;case"function":{const t=a(n);s(t)&&Object.assign(c,t);break}}}r(c)||function(t,e){D.value.push({context:t,data:e})}(t,c),x+=1,x===S&&(x=0,function(){if(D.value.length<1)return;const t=D.value;D.value=[];const{namespace:e}=p(),n=t.length;for(let o=0;o<n;o++){const n=t[o],{data:c}=n.context,s=v(n.data,e?c[e]:c,e);r(s)||(n.diffData=s)}for(let e=0;e<n;e++){const n=t[e];n.diffData&&n.context.setData(n.diffData)}}())});return()=>{S-=1,n()}}function k({type:t="page",mapState:n,mapDispatch:c,manual:s}={}){"page"!==t&&"component"!==t&&u("type属性只能是page或component");const a="page"===t,{namespace:i,manual:f}=p();return"boolean"!=typeof s&&(s=f),function(f){if(o(n)&&n.length>0){const o=new Map,c=y(n);f.data=Object.assign(f.data||{},i?{[i]:c}:c);const[s,a]=e[t],u=f[s],l=f[a];f[s]=function(...t){const e=v(y(n),i?this.data[i]:this.data,i);r(e)||this.setData(e);const c=Symbol("instanceId"),s=w({id:c,data:this.data,setData:this.setData.bind(this)},n);o.set(c,s),this.$$instanceId=c,u&&u.apply(this,t)},f[a]=function(...t){l&&l.apply(this,t);const e=this.$$instanceId;if(o.has(e)){const t=o.get(e);o.delete(e),t()}}}if(c){const t=a?f:f.methods=f.methods||{};m(c,t)}return s?f:a?Page(f):Component(f)}}const A=(t={})=>k(Object.assign(Object.assign({},t),{type:"page"})),I=(t={})=>k(Object.assign(Object.assign({},t),{type:"component"}));export{I as $component,A as $page,k as connect,l as setProvider,b as useDispatch,j as useRef,g as useState,d as useStore,h as useSubscribe};
