const t={wechat:{page:["onLoad","onUnload"],component:["attached","detached"]},alipay:{page:["onLoad","onUnload"],component:["didMount","didUnmount"]}};let n=null;function e(){if(!n){const e=getApp();if(!e)throw new Error("App 实例对象不存在");const{provider:o}=e;if(!o)throw new Error("App 实例对象上不存在 provider 对象");const{platform:s="wechat",store:c,namespace:a="",manual:r=!1}=o;if(s&&"wechat"!==s&&"alipay"!==s)throw new Error("platform 只能是 wechat 或 alipay");if(!c)throw new Error("Redux 的 Store 实例对象不存在");n={store:c,namespace:a,manual:r,lifetimes:t[s]}}return n}const o=Array.isArray,s=t=>"function"==typeof t,c=Object.prototype.toString,a=t=>"[object Object]"===c.call(t),r=t=>c.call(t),i=Object.keys,l=t=>i(t).length<1;function f(t){return o(t)?function(t){const n=e().store.getState(),o={};for(let e=0,s=t.length;e<s;e++){const s=t[e];s in n&&(o[s]=n[s])}return l(o)?null:o}(t):s(t)?function(t){const n=t(e().store.getState());if(!a(n))throw new Error("mapState 函数必须返回一个对象");return l(n)?null:n}(t):null}function u(t,n){a(t)?function(t,n){const{dispatch:o}=e().store;for(const e in t){const c=t[e];s(c)&&(n[e]=(...t)=>o(c.apply(null,t)))}}(t,n):s(t)&&function(t,n){const o=t(e().store.dispatch);if(!a(o))throw new Error("mapDispatch 函数必须返回一个对象");Object.assign(n,o)}(t,n)}const h="[object Object]",p="[object Array]";function d(t,n,e,o){const s=i(t),c=i(n),a=s.length,l=c.length;if(!(a<1&&l<1))if(a<1||l<1||a<l)e[o]=t;else{for(let n=0;n<l;n++){const a=c[n];if(s.indexOf(a)<0)return void(e[o]=t)}for(let i=0;i<a;i++){const a=s[i],l=t[a],f=`${o}.${a}`;if(c.indexOf(a)<0){e[f]=l;continue}const u=n[a];if(l!==u){const t=r(l);t!==r(u)?e[f]=l:t===h?d(l,u,e,f):t===p?g(l,u,e,f):e[f]=l}}}}function g(t,n,e,o){const s=t.length,c=n.length;if(!(s<1&&c<1))if(s<1||c<1||s<c)e[o]=t;else for(let a=0;a<s;a++){const s=t[a],i=`${o}[${a}]`;if(a>=c){e[i]=s;continue}const l=n[a];if(s!==l){const t=r(s);t!==r(l)?e[i]=s:t===h?d(s,l,e,i):t===p?g(s,l,e,i):e[i]=s}}}function m(t,n,e=""){const o=i(t),s=i(n),c=o.length,a=s.length;if(c<1&&a<1)return{};if(c<1||a<1)return e?{[e]:t}:t;const l={};for(let a=0;a<c;a++){const c=o[a],i=t[c],f=e?`${e}.${c}`:c;if(s.indexOf(c)<0){l[f]=i;continue}const u=n[c];if(i!==u){const t=r(i);t!==r(u)?l[f]=i:t===h?d(i,u,l,f):t===p?g(i,u,l,f):l[f]=i}}return l}var w=new class{constructor(){this.queue=[]}push(t,n,e){const o=this.queue;let c=null;for(let n=0,e=o.length;n<e;n++)if(o[n].thisArg===t){c=o[n];break}c||(c={thisArg:t,data:{},callbacks:[]},o.push(c)),Object.assign(c.data,n),s(e)&&c.callbacks.push(e),Promise.resolve().then(this.exec.bind(this))}exec(){if(this.queue.length<1)return;const t=this.queue;this.queue=[];const{namespace:n}=e();for(let e=0,o=t.length;e<o;e++){const o=t[e],{thisArg:s,data:c}=o,a=m(c,n?s.data[n]:s.data,n);l(a)||(o.diffData=a)}let o;for(;o=t.shift();){const{thisArg:t,diffData:n,callbacks:e}=o;let s;e.length>0&&(s=()=>{let t;for(;t=e.shift();)t()}),n?t.setData(n,s):s&&s()}}};function b({type:t="page",mapState:n,mapDispatch:s,manual:c}={}){const{namespace:a,manual:r,lifetimes:i}=e();if(t&&"page"!==t&&"component"!==t)throw new Error("type 属性只能是 page 或 component");return"boolean"!=typeof c&&(c=r),function(r){const h="page"===t;if(r.$type=t,n){const s=f(n);if(s){const[c,u]=i[t],h=r[c],p=r[u];let d=null;r.data=Object.assign(r.data||{},a?{[a]:s}:s),r[c]=function(...t){const s=m(f(n),a?this.data[a]:this.data,a);l(s)||this.setData(s),d=function(t,n){const{store:s}=e();let c=s.getState();return s.subscribe(()=>{const e=s.getState();let a=null;if(o(n))for(let t=0,o=n.length;t<o;t++){const o=n[t];e[o]!==c[o]&&(a||(a={}),a[o]=e[o])}else a=n(e);a&&w.push(t,a),c=e})}(this,n),h&&h.apply(this,t)},r[u]=function(){p&&p.call(this),d&&(d(),d=null)}}}if(s){const t=h?r:r.methods=r.methods||{};u(s,t)}return c?r:h?Page(r):Component(r)}}const y=()=>e().store,j=()=>e().store.dispatch;export{b as connect,j as useDispatch,y as useStore};
