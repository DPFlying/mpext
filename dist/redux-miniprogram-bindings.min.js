const t=wx,e={page:["onLoad","onUnload"],component:["attached","detached"]},n=t=>"function"==typeof t,o=Array.isArray,c=Object.prototype.toString,a=t=>"[object Object]"===c.call(t),s=t=>c.call(t),i=Object.keys,r=t=>i(t).length<1,f=Object.prototype.hasOwnProperty,l=t=>{throw new Error(t)};function u(e){a(e)||l("provider必须是一个Object");const{store:o,namespace:c="",manual:s=!1}=e;o&&n(o.getState)&&n(o.dispatch)&&n(o.subscribe)||l("store必须为Redux的Store实例对象"),t.$$provider={store:o,namespace:c,manual:s}}function p(){return t.$$provider||l("请先设置provider"),t.$$provider}const g=()=>p().store,d=()=>p().store.getState(),b=()=>p().store.dispatch;function h(t){const{store:e}=p();let n=e.getState();return e.subscribe(()=>{const o=e.getState();t(o,n),n=o})}function j(t){const{store:e}=p();let n,o;const c={};return Object.defineProperty(c,"value",{configurable:!1,enumerable:!0,get(){return c=e.getState(),n!==c&&(o=t(c)),n=c,o;var c}}),c}function y(t){const e=d(),n={};for(let o=0,c=t.length;o<c;o++){const c=t[o];switch(typeof c){case"string":f.call(e,c)&&(n[c]=e[c]);break;case"function":{const t=c(e);a(t)&&Object.assign(n,t);break}}}return n}function O(t,e){a(t)?function(t,e){const o=b(),c=i(t);for(let a=0,s=c.length;a<s;a++){const s=c[a],i=t[s];n(i)&&(e[s]=(...t)=>o(i.apply(null,t)))}}(t,e):n(t)&&function(t,e){const n=t(b());a(n)||l("mapDispatch函数必须返回一个对象"),Object.assign(e,n)}(t,e)}function m(t,e,n,o){const c=i(t),a=i(e),r=c.length,f=a.length;if(!(r<1&&f<1))if(r<1||f<1||r<f)n[o]=t;else{for(let e=0;e<f;e++){const s=a[e];if(c.indexOf(s)<0)return void(n[o]=t)}for(let i=0;i<r;i++){const r=c[i],f=t[r],l=`${o}.${r}`;if(a.indexOf(r)<0){n[l]=f;continue}const u=e[r];if(f!==u){const t=s(f);t!==s(u)?n[l]=f:"[object Object]"===t?m(f,u,n,l):"[object Array]"===t?$(f,u,n,l):n[l]=f}}}}function $(t,e,n,o){const c=t.length,a=e.length;if(!(c<1&&a<1))if(c<1||a<1||c<a)n[o]=t;else for(let i=0;i<c;i++){const c=t[i],r=`${o}[${i}]`;if(i>=a){n[r]=c;continue}const f=e[i];if(c!==f){const t=s(c);t!==s(f)?n[r]=c:"[object Object]"===t?m(c,f,n,r):"[object Array]"===t?$(c,f,n,r):n[r]=c}}}function v(t,e,n=""){const o=i(t),c=i(e),a=o.length,r=c.length;if(a<1&&r<1)return{};if(a<1||r<1)return n?{[n]:t}:t;const f={};for(let i=0;i<a;i++){const a=o[i],r=t[a],l=n?`${n}.${a}`:a;if(c.indexOf(a)<0){f[l]=r;continue}const u=e[a];if(r!==u){const t=s(r);t!==s(u)?f[l]=r:"[object Object]"===t?m(r,u,f,l):"[object Array]"===t?$(r,u,f,l):f[l]=r}}return f}const x={value:[]};let D=0,S=0;function w(t,e){D+=1;const n=h((n,o)=>{const c={};for(let t=0,s=e.length;t<s;t++){const s=e[t];switch(typeof s){case"string":n[s]!==o[s]&&(c[s]=n[s]);break;case"function":{const t=s(n);a(t)&&Object.assign(c,t);break}}}r(c)||function(t,e){x.value.push({context:t,data:e})}(t,c),S+=1,S===D&&(S=0,function(){if(x.value.length<1)return;const t=x.value;x.value=[];const{namespace:e}=p(),n=t.length;for(let o=0;o<n;o++){const n=t[o],{data:c}=n.context,a=v(n.data,e?c[e]:c,e);r(a)||(n.diffData=a)}for(let e=0;e<n;e++){const n=t[e];n.diffData&&n.context.setData(n.diffData)}}())});return()=>{D-=1,n()}}function k({type:t="page",mapState:n,mapDispatch:c,manual:a}={}){"page"!==t&&"component"!==t&&l("type属性只能是page或component");const s="page"===t,{namespace:i,manual:f}=p();return"boolean"!=typeof a&&(a=f),function(f){if(o(n)&&n.length>0){const o=new Map,c=y(n);f.data=Object.assign(f.data||{},i?{[i]:c}:c);const[a,s]=e[t],l=f[a],u=f[s];f[a]=function(...t){const e=v(y(n),i?this.data[i]:this.data,i);r(e)||this.setData(e);const c=Symbol("instanceId"),a=w({id:c,data:this.data,setData:this.setData.bind(this)},n);o.set(c,a),this.$$instanceId=c,l&&l.apply(this,t)},f[s]=function(...t){u&&u.apply(this,t);const e=this.$$instanceId;if(o.has(e)){const t=o.get(e);o.delete(e),t()}}}if(c){const t=s?f:f.methods=f.methods||{};O(c,t)}return a?f:s?Page(f):Component(f)}}const A=(t={})=>k(Object.assign(Object.assign({},t),{type:"page"})),I=(t={})=>k(Object.assign(Object.assign({},t),{type:"component"}));export{I as $component,A as $page,k as connect,u as setProvider,b as useDispatch,j as useRef,d as useState,g as useStore,h as useSubscribe};
