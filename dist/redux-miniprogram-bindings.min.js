const t={wechat:{page:["onLoad","onUnload"],component:["attached","detached"]},alipay:{page:["onLoad","onUnload"],component:["didMount","didUnmount"]}};let e=null;function n(){if(!e){const n=getApp();if(!n)throw new Error("App 实例对象不存在");const{provider:o}=n;if(!o)throw new Error("App 实例对象上不存在 provider 对象");const{platform:c="wechat",store:r,namespace:s="",manual:a=!1}=o;if(c&&"wechat"!==c&&"alipay"!==c)throw new Error("platform 只能是 wechat 或 alipay");if(!r)throw new Error("Redux 的 Store 实例对象不存在");e={store:r,namespace:s,manual:a,lifetimes:t[c]}}return e}const o=Array.isArray,c=t=>"function"==typeof t,r=Object.prototype.toString,s=t=>"[object Object]"===r.call(t),a=t=>r.call(t),i=Object.keys,l=t=>i(t).length<1;let f=[];function u(t){const e=n().store.getState(),o={};for(let n=0,c=t.length;n<c;n++){const c=t[n];c in e&&(o[c]=e[c])}return l(o)?null:o}function h(t,e){const o=n().store.getState();e&&(f=[],function(t){const e=i(t);for(let n=0,o=e.length;n<o;n++){const o=e[n],c=Object.getOwnPropertyDescriptor(t,o);if(c&&!1===c.configurable)throw new Error("Function 类型的 mapState 需要使用 defineProperty 进行依赖收集，请勿将 configurable 属性定义为 false");const r=c&&c.get;if(r&&r.__ob__)continue;const s=c&&c.set;let a=t[o];const i=()=>(f.indexOf(o)<0&&f.push(o),r?r.call(t):a);i.__ob__=!0;const l=e=>{r&&!s||(s?s.call(t,e):a=e)};Object.defineProperty(t,o,{configurable:!0,enumerable:!0,get:i,set:l})}}(o));const c=t(o);if(!s(c))throw new Error("mapState 函数必须返回一个对象");return[l(c)?null:c,e?[...f]:null]}function p(t,e=!1){return o(t)?[u(t),e?[...t]:null]:c(t)?h(t,e):[null,null]}function g(t,e){s(t)?function(t,e){const{dispatch:o}=n().store;for(const n in t){const r=t[n];c(r)&&(e[n]=(...t)=>o(r.apply(null,t)))}}(t,e):c(t)&&function(t,e){const o=t(n().store.dispatch);if(!s(o))throw new Error("mapDispatch 函数必须返回一个对象");Object.assign(e,o)}(t,e)}function d(t,e,n,o){const c=i(t),r=i(e),s=c.length,l=r.length;if(!(s<1&&l<1))if(s<1||l<1||s<l)n[o]=t;else{for(let e=0;e<l;e++){const s=r[e];if(c.indexOf(s)<0)return void(n[o]=t)}for(let i=0;i<s;i++){const s=c[i],l=t[s],f=`${o}.${s}`;if(r.indexOf(s)<0){n[f]=l;continue}const u=e[s];if(l!==u){const t=a(l);t!==a(u)?n[f]=l:"[object Object]"===t?d(l,u,n,f):"[object Array]"===t?b(l,u,n,f):n[f]=l}}}}function b(t,e,n,o){const c=t.length,r=e.length;if(!(c<1&&r<1))if(c<1||r<1||c<r)n[o]=t;else for(let s=0;s<c;s++){const c=t[s],i=`${o}[${s}]`;if(s>=r){n[i]=c;continue}const l=e[s];if(c!==l){const t=a(c);t!==a(l)?n[i]=c:"[object Object]"===t?d(c,l,n,i):"[object Array]"===t?b(c,l,n,i):n[i]=c}}}function m(t,e,n=""){const o=i(t),c=i(e),r=o.length,s=c.length;if(r<1&&s<1)return{};if(r<1||s<1)return n?{[n]:t}:t;const l={};for(let s=0;s<r;s++){const r=o[s],i=t[r],f=n?`${n}.${r}`:r;if(c.indexOf(r)<0){l[f]=i;continue}const u=e[r];if(i!==u){const t=a(i);t!==a(u)?l[f]=i:"[object Object]"===t?d(i,u,l,f):"[object Array]"===t?b(i,u,l,f):l[f]=i}}return l}var w=new class{constructor(){this.queue=[]}push(t,e,n){const o=this.queue;let r=null;for(let e=0,n=o.length;e<n;e++)if(o[e].thisArg===t){r=o[e];break}r||(r={thisArg:t,data:{},callbacks:[]},o.push(r)),Object.assign(r.data,e),c(n)&&r.callbacks.push(n),Promise.resolve().then(this.exec.bind(this))}exec(){if(this.queue.length<1)return;const t=this.queue;this.queue=[];const{namespace:e}=n();for(let n=0,o=t.length;n<o;n++){const o=t[n],{thisArg:c,data:r}=o,s=m(r,e?c.data[e]:c.data,e);l(s)||(o.diffData=s)}let o;for(;o=t.shift();){const{thisArg:t,diffData:e,callbacks:n}=o;let c;n.length>0&&(c=()=>{let t;for(;t=n.shift();)t()}),e?t.setData(e,c):c&&c()}}};function y({type:t="page",mapState:e,mapDispatch:c,manual:r}={}){const{namespace:s,manual:a,lifetimes:i}=n();if(t&&"page"!==t&&"component"!==t)throw new Error("type 属性只能是 page 或 component");return"boolean"!=typeof r&&(r=a),function(a){const f="page"===t;if(a.$type=t,e){const[c,r]=p(e,!0);if(c){const[f,u]=i[t],h=a[f],g=a[u];let d=null;a.data=Object.assign(a.data||{},s?{[s]:c}:c),a[f]=function(...t){const c=m(p(e,!1)[0],s?this.data[s]:this.data,s);l(c)||this.setData(c),d=function(t,e,c){const{store:r}=n();let s=r.getState();return r.subscribe(()=>{const n=r.getState();let a=null;if(o(e))for(let t=0,o=e.length;t<o;t++){const o=e[t];n[o]!==s[o]&&(a||(a={}),a[o]=n[o])}else for(let t=0,o=c.length;t<o;t++){const o=c[t];if(n[o]!==s[o]){a=e(n);break}}a&&w.push(t,a),s=n})}(this,e,r),h&&h.apply(this,t)},a[u]=function(){g&&g.call(this),d&&(d(),d=null)}}}if(c){const t=f?a:a.methods=a.methods||{};g(c,t)}return r?a:f?Page(a):Component(a)}}const j=()=>n().store,O=()=>n().store.dispatch;export{y as connect,O as useDispatch,j as useStore};
