const t={wechat:{page:["onLoad","onUnload"],component:["attached","detached"]},alipay:{page:["onLoad","onUnload"],component:["didMount","didUnmount"]}};let e=null;function n(){if(!e){const n=getApp();if(!n)throw new Error("App 实例对象不存在");const{provider:o}=n;if(!o)throw new Error("App 实例对象上不存在 provider 对象");const{platform:c="wechat",store:s,namespace:r="",manual:a=!1}=o;if(c&&"wechat"!==c&&"alipay"!==c)throw new Error("platform 只能是 wechat 或 alipay");if(!s)throw new Error("Redux 的 Store 实例对象不存在");e={store:s,namespace:r,manual:a,lifetimes:t[c]}}return e}const o=Array.isArray,c=t=>"function"==typeof t,s=Object.prototype.toString,r=t=>"[object Object]"===s.call(t),a=t=>s.call(t),i=Object.keys,l=t=>i(t).length<1;let f=[];function u(t){const e=n().store.getState(),o={};for(let n=0,c=t.length;n<c;n++){const c=t[n];c in e&&(o[c]=e[c])}return l(o)?null:o}function h(t,e){const o=n().store.getState();e&&(f=[],function(t){const e=i(t);for(let n=0,o=e.length;n<o;n++){const o=e[n],c=Object.getOwnPropertyDescriptor(t,o);if(c&&!1===c.configurable)throw new Error("Function 类型的 mapState 需要使用 defineProperty 进行依赖收集，请勿将 configurable 属性定义为 false");const s=c&&c.get;if(s&&s.__ob__)continue;const r=c&&c.set;let a=t[o];const i=()=>(f.indexOf(o)<0&&f.push(o),s?s.call(t):a);i.__ob__=!0;const l=e=>{s&&!r||(r?r.call(t,e):a=e)};Object.defineProperty(t,o,{configurable:!0,enumerable:!0,get:i,set:l})}}(o));const c=t(o);if(!r(c))throw new Error("mapState 函数必须返回一个对象");return[l(c)?null:c,e?[...f]:null]}function p(t,e=!1){return o(t)?[u(t),e?[...t]:null]:c(t)?h(t,e):[null,null]}function g(t,e){r(t)?function(t,e){const{dispatch:o}=n().store;for(const n in t){const s=t[n];c(s)&&(e[n]=(...t)=>o(s.apply(null,t)))}}(t,e):c(t)&&function(t,e){const o=t(n().store.dispatch);if(!r(o))throw new Error("mapDispatch 函数必须返回一个对象");Object.assign(e,o)}(t,e)}const d="[object Object]",b="[object Array]";function m(t,e,n,o){const c=i(t),s=i(e),r=c.length,l=s.length;if(!(r<1&&l<1))if(r<1||l<1||r<l)n[o]=t;else{for(let e=0;e<l;e++){const r=s[e];if(c.indexOf(r)<0)return void(n[o]=t)}for(let i=0;i<r;i++){const r=c[i],l=t[r],f=`${o}.${r}`;if(s.indexOf(r)<0){n[f]=l;continue}const u=e[r];if(l!==u){const t=a(l);t!==a(u)?n[f]=l:t===d?m(l,u,n,f):t===b?w(l,u,n,f):n[f]=l}}}}function w(t,e,n,o){const c=t.length,s=e.length;if(!(c<1&&s<1))if(c<1||s<1||c<s)n[o]=t;else for(let r=0;r<c;r++){const c=t[r],i=`${o}[${r}]`;if(r>=s){n[i]=c;continue}const l=e[r];if(c!==l){const t=a(c);t!==a(l)?n[i]=c:t===d?m(c,l,n,i):t===b?w(c,l,n,i):n[i]=c}}}function y(t,e,n=""){const o=i(t),c=i(e),s=o.length,r=c.length;if(s<1&&r<1)return{};if(s<1||r<1)return n?{[n]:t}:t;const l={};for(let r=0;r<s;r++){const s=o[r],i=t[s],f=n?`${n}.${s}`:s;if(c.indexOf(s)<0){l[f]=i;continue}const u=e[s];if(i!==u){const t=a(i);t!==a(u)?l[f]=i:t===d?m(i,u,l,f):t===b?w(i,u,l,f):l[f]=i}}return l}var O=new class{constructor(){this.queue=[]}push(t,e,n){const o=this.queue;let s=null;for(let e=0,n=o.length;e<n;e++)if(o[e].thisArg===t){s=o[e];break}s||(s={thisArg:t,data:{},callbacks:[]},o.push(s)),Object.assign(s.data,e),c(n)&&s.callbacks.push(n),Promise.resolve().then(this.exec.bind(this))}exec(){if(this.queue.length<1)return;const t=this.queue;this.queue=[];const{namespace:e}=n();for(let n=0,o=t.length;n<o;n++){const o=t[n],{thisArg:c,data:s}=o,r=y(s,e?c.data[e]:c.data,e);l(r)||(o.diffData=r)}let o;for(;o=t.shift();){const{thisArg:t,diffData:e,callbacks:n}=o;let c;n.length>0&&(c=()=>{let t;for(;t=n.shift();)t()}),e?t.setData(e,c):c&&c()}}};function j({type:t="page",mapState:e,mapDispatch:c,manual:s}={}){const{namespace:r,manual:a,lifetimes:i}=n();if(t&&"page"!==t&&"component"!==t)throw new Error("type 属性只能是 page 或 component");return"boolean"!=typeof s&&(s=a),function(a){const f="page"===t;if(a.$type=t,e){const[c,s]=p(e,!0);if(c){const[f,u]=i[t],h=a[f],g=a[u];let d=null;a.data=Object.assign(a.data||{},r?{[r]:c}:c),a[f]=function(...t){const c=y(p(e,!1)[0],r?this.data[r]:this.data,r);l(c)||this.setData(c),d=function(t,e,c){const{store:s}=n();let r=s.getState();return s.subscribe(()=>{const n=s.getState();let a=null;if(o(e))for(let t=0,o=e.length;t<o;t++){const o=e[t];n[o]!==r[o]&&(a||(a={}),a[o]=n[o])}else for(let t=0,o=c.length;t<o;t++){const o=c[t];if(n[o]!==r[o]){a=e(n);break}}a&&O.push(t,a),r=n})}(this,e,s),h&&h.apply(this,t)},a[u]=function(){g&&g.call(this),d&&(d(),d=null)}}}if(c){const t=f?a:a.methods=a.methods||{};g(c,t)}return s?a:f?Page(a):Component(a)}}const A=()=>n().store,S=()=>n().store.dispatch;export{j as connect,S as useDispatch,A as useStore};
